<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarChart Generator</title>
    
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #111214;
            color: #111214;
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 420px;
            min-height: 100vh;
        }

        /* Left Panel - Image Preview */
        .preview-panel {
            background: #18181b;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #27272a;
            position: relative;
        }

        .preview-placeholder {
            color: #52525b;
            font-size: 14px;
            text-align: center;
        }

        .preview-image {
            max-width: 90%;
            max-height: 90vh;
            object-fit: contain;
            display: none;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 3px solid #27272a;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Right Panel - Form */
        .form-panel {
            padding: 32px 24px;
            overflow-y: auto;
            background: #0f1113;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #fafafa;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #a1a1aa;
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #fafafa;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 12px 0;
            padding-top: 16px;
            border-top: 1px solid #27272a;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-generate {
            width: 100%;
            padding: 12px;
            background: #6366f1;
            color: white;
            margin-top: 24px;
        }

        .btn-generate:hover {
            background: #4f46e5;
        }

        .btn-generate:disabled {
            background: #3f3f46;
            cursor: not-allowed;
        }

        .btn-cart {
            width: 100%;
            padding: 12px;
            background: #22c55e;
            color: white;
            margin-top: 12px;
        }

        .btn-cart:hover:not(:disabled) {
            background: #16a34a;
        }

        .btn-cart:disabled {
            background: #3f3f46;
            cursor: not-allowed;
        }

        .btn-cart.added {
            background: #27272a;
            border: 1px solid #22c55e;
            color: #22c55e;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #18181b;
            border: 1px solid #3f3f46;
            color: #fafafa;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #22c55e;
        }

        .toast.success::before {
            content: '✓';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: #22c55e;
            border-radius: 50%;
            font-size: 12px;
            color: white;
        }

        .toast.error {
            border-color: #ef4444;
        }

        .toast.error::before {
            content: '✕';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border-radius: 50%;
            font-size: 12px;
            color: white;
        }

        .error-message {
            background: #7f1d1d;
            border: 1px solid #991b1b;
            color: #fca5a5;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 16px;
            display: none;
        }

        .api-key-group {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #27272a;
        }

        .api-key-group input {
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        /* Location Autocomplete */
        .location-wrapper {
            position: relative;
        }

        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .location-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #3f3f46;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: #3f3f46;
        }

        .suggestion-item .main-text {
            color: #fafafa;
        }

        .suggestion-item .sub-text {
            color: #71717a;
            font-size: 12px;
            margin-top: 2px;
        }

        .searching {
            padding: 10px 12px;
            color: #71717a;
            font-size: 13px;
        }

        /* Coordinates display */
        .coords-display {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: #71717a;
        }

        .coords-display span {
            color: #a1a1aa;
        }

        /* Datetime row */
        .datetime-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Flatpickr overrides */
        .flatpickr-input {
            background: #27272a !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Preview -->
        <div class="preview-panel">
            <div class="preview-placeholder" id="placeholder">
                Generated star map will appear here
            </div>
            <div class="loading-spinner" id="spinner"></div>
            <img class="preview-image" id="previewImage" alt="Generated Star Map">
        </div>

        <!-- Right Panel - Form -->
        <div class="form-panel">
            <h1>Generate Star Map</h1>

            <form id="starmapForm">
                <div class="api-key-group">
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" placeholder="Enter your API key" required>
                </div>

                <div class="form-group">
                    <label for="title">Title (optional)</label>
                    <input type="text" id="title" placeholder="e.g., Our Wedding Night" maxlength="255">
                </div>

                <div class="section-title">Location</div>

                <div class="form-group location-wrapper">
                    <label for="locationSearch">Search Location</label>
                    <input type="text" id="locationSearch" placeholder="Type a city or address..." autocomplete="off">
                    <div class="location-suggestions" id="suggestions"></div>
                    <div class="coords-display" id="coordsDisplay" style="display: none;">
                        <div>Lat: <span id="latDisplay">—</span></div>
                        <div>Lng: <span id="lngDisplay">—</span></div>
                    </div>
                </div>

                <!-- Hidden inputs for lat/lng -->
                <input type="hidden" id="latitude" required>
                <input type="hidden" id="longitude" required>

                <div class="section-title">Date & Time</div>

                <div class="datetime-row">
                    <div class="form-group">
                        <label for="datePicker">Date</label>
                        <input type="text" id="datePicker" placeholder="Select date" required>
                    </div>
                    <div class="form-group">
                        <label for="timePicker">Time</label>
                        <input type="text" id="timePicker" placeholder="Select time" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="timezone">UTC Offset (hours)</label>
                    <input type="number" id="timezone" min="-12" max="14" placeholder="-12 to 14" required>
                </div>

                <button type="submit" class="btn btn-generate" id="submitBtn">
                    Generate Star Map
                </button>

                <button type="button" class="btn btn-cart" id="addToCartBtn" disabled>
                    Add to Cart
                </button>

                <div class="error-message" id="errorMessage"></div>
            </form>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000'; // Change to your server URL
        const SHOPIFY_VARIANT_ID = 52466655658168; // Star Map product variant ID

        // DOM Elements
        const form = document.getElementById('starmapForm');
        const submitBtn = document.getElementById('submitBtn');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const placeholder = document.getElementById('placeholder');
        const spinner = document.getElementById('spinner');
        const previewImage = document.getElementById('previewImage');
        const errorMessage = document.getElementById('errorMessage');
        const searchInput = document.getElementById('locationSearch');
        const suggestions = document.getElementById('suggestions');
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');
        const coordsDisplay = document.getElementById('coordsDisplay');
        const latDisplay = document.getElementById('latDisplay');
        const lngDisplay = document.getElementById('lngDisplay');
        const toast = document.getElementById('toast');

        // State tracking for Add to Cart lock
        let currentGeneratedParams = null;  // Params of the currently displayed image
        let lastAddedToCartParams = null;   // Params that were last successfully added to cart

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3500);
        }

        // ========== CART BUTTON STATE ==========
        function getParamsHash(params) {
            // Create a simple hash of params to compare
            return JSON.stringify(params);
        }

        function updateCartButtonState() {
            if (!currentGeneratedParams) {
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = 'Add to Cart';
                addToCartBtn.classList.remove('added');
                return;
            }

            const currentHash = getParamsHash(currentGeneratedParams);
            const lastAddedHash = lastAddedToCartParams ? getParamsHash(lastAddedToCartParams) : null;

            if (currentHash === lastAddedHash) {
                // Same params as last added - show "Added" state
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = '✓ Added to Cart';
                addToCartBtn.classList.add('added');
            } else {
                // Different params or never added - enable button
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = 'Add to Cart';
                addToCartBtn.classList.remove('added');
            }
        }

        // ========== LOCATION AUTOCOMPLETE ==========
        let searchTimeout = null;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                suggestions.classList.remove('active');
                return;
            }

            // Debounce: wait 300ms after user stops typing
            searchTimeout = setTimeout(() => searchLocation(query), 300);
        });

        async function searchLocation(query) {
            suggestions.innerHTML = '<div class="searching">Searching...</div>';
            suggestions.classList.add('active');

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
                    { headers: { 'Accept-Language': 'en' } }
                );
                const results = await response.json();
                
                suggestions.innerHTML = '';
                
                if (results.length === 0) {
                    suggestions.innerHTML = '<div class="searching">No results found</div>';
                    return;
                }

                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    // Parse display name for cleaner presentation
                    const parts = result.display_name.split(', ');
                    const mainText = parts[0];
                    const subText = parts.slice(1, 3).join(', ');
                    
                    item.innerHTML = `
                        <div class="main-text">${mainText}</div>
                        <div class="sub-text">${subText}</div>
                    `;
                    
                    item.addEventListener('click', () => selectLocation(result));
                    suggestions.appendChild(item);
                });
            } catch (error) {
                console.error('Search failed:', error);
                suggestions.innerHTML = '<div class="searching">Search failed</div>';
            }
        }

        function selectLocation(result) {
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            
            // Update hidden inputs
            latInput.value = lat;
            lngInput.value = lng;
            
            // Update display
            const parts = result.display_name.split(', ');
            searchInput.value = parts.slice(0, 2).join(', ');
            
            latDisplay.textContent = lat.toFixed(4);
            lngDisplay.textContent = lng.toFixed(4);
            coordsDisplay.style.display = 'flex';
            
            // Hide suggestions
            suggestions.classList.remove('active');
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!suggestions.contains(e.target) && e.target !== searchInput) {
                suggestions.classList.remove('active');
            }
        });

        // ========== FLATPICKR DATE/TIME ==========
        const datePicker = flatpickr('#datePicker', {
            dateFormat: 'Y-m-d',
            theme: 'dark',
            defaultDate: new Date()
        });

        const timePicker = flatpickr('#timePicker', {
            enableTime: true,
            noCalendar: true,
            dateFormat: 'H:i',
            time_24hr: true,
            theme: 'dark',
            defaultDate: new Date()
        });

        // Auto-detect browser timezone offset
        const browserOffset = -new Date().getTimezoneOffset() / 60;
        document.getElementById('timezone').value = browserOffset;

        // ========== FORM SUBMISSION ==========
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate location
            if (!latInput.value || !lngInput.value) {
                errorMessage.textContent = 'Please select a location from the suggestions';
                errorMessage.style.display = 'block';
                return;
            }

            // Reset UI
            errorMessage.style.display = 'none';
            placeholder.style.display = 'none';
            previewImage.style.display = 'none';
            spinner.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';

            // Parse date and time from pickers
            const dateVal = datePicker.selectedDates[0];
            const timeVal = timePicker.selectedDates[0];

            if (!dateVal || !timeVal) {
                errorMessage.textContent = 'Please select date and time';
                errorMessage.style.display = 'block';
                spinner.style.display = 'none';
                placeholder.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Star Map';
                return;
            }

            const payload = {
                latitude: parseFloat(latInput.value),
                longitude: parseFloat(lngInput.value),
                year: dateVal.getFullYear(),
                month: dateVal.getMonth() + 1,
                day: dateVal.getDate(),
                hour: timeVal.getHours(),
                minute: timeVal.getMinutes(),
                timezone_offset: parseInt(document.getElementById('timezone').value),
                title: document.getElementById('title').value || null
            };

            const apiKey = document.getElementById('apiKey').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/starmaps/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                // Response is binary PNG - use blob
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                // Revoke previous URL if exists
                if (previewImage.src.startsWith('blob:')) {
                    URL.revokeObjectURL(previewImage.src);
                }

                previewImage.src = imageUrl;
                previewImage.style.display = 'block';

                // Store cache ID for potential save operation
                const cacheId = response.headers.get('X-Cache-Id');
                if (cacheId) {
                    previewImage.dataset.cacheId = cacheId;
                    console.log('Cache ID:', cacheId);
                }

                // Store current params for cart button state tracking
                currentGeneratedParams = {
                    ...payload,
                    location: searchInput.value
                };
                
                // Update cart button state
                updateCartButtonState();

            } catch (error) {
                console.error('Generation failed:', error);
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
                placeholder.style.display = 'block';
            } finally {
                spinner.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Star Map';
            }
        });

        // ========== ADD TO CART ==========
        addToCartBtn.addEventListener('click', async () => {
            const cacheId = previewImage.dataset.cacheId;
            const apiKey = document.getElementById('apiKey').value;

            if (!cacheId) {
                showToast('Please generate a star map first', 'error');
                return;
            }

            // Disable button while processing
            addToCartBtn.disabled = true;
            addToCartBtn.textContent = 'Adding...';

            try {
                // Step 1: Save to permanent storage
                const saveResponse = await fetch(`${API_BASE_URL}/api/v1/starmaps/${cacheId}/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        title: currentGeneratedParams.title
                    })
                });

                if (!saveResponse.ok) {
                    const errorData = await saveResponse.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to save star map');
                }

                const savedStarmap = await saveResponse.json();
                console.log('Saved starmap:', savedStarmap);

                // Step 2: Build the image URL for fulfillment
                const imageUrl = `${API_BASE_URL}/api/v1/starmaps/${savedStarmap.id}`;

                // Step 3: Format date for display
                const dateObj = new Date(currentGeneratedParams.year, currentGeneratedParams.month - 1, currentGeneratedParams.day);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                // Step 4: Add to Shopify cart with line item properties
                const cartResponse = await fetch('/cart/add.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: SHOPIFY_VARIANT_ID,
                        quantity: 1,
                        properties: {
                            '_starmap_id': savedStarmap.id,
                            '_image_url': imageUrl,
                            'Title': currentGeneratedParams.title || 'The Night Sky',
                            'Location': currentGeneratedParams.location,
                            'Date': formattedDate,
                            'Coordinates': `${currentGeneratedParams.latitude.toFixed(4)}°, ${currentGeneratedParams.longitude.toFixed(4)}°`
                        }
                    })
                });

                if (!cartResponse.ok) {
                    // Handle Shopify cart errors
                    const cartError = await cartResponse.json().catch(() => ({}));
                    throw new Error(cartError.description || 'Failed to add to cart');
                }

                // Success!
                lastAddedToCartParams = { ...currentGeneratedParams };
                updateCartButtonState();
                showToast('Star map added to cart!', 'success');

            } catch (error) {
                console.error('Add to cart failed:', error);
                showToast(error.message || 'Failed to add to cart', 'error');
                
                // Re-enable button on error
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = 'Add to Cart';
            }
        });
    </script>
</body>
</html>